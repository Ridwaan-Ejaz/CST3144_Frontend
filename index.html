<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>After School Activities</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <h1>After School Activities</h1>

    
    <input type="text" v-model="searchQuery" placeholder="Search lessons...">
    <button @click="applySearch">Search</button>

    <!-- Lessons Page -->
    <div v-if="currentView === 'lessons'">
      <div class="controls">
        <label>Sort by:</label>
        <select v-model="sortKey">
          <option value="subject">Activity</option>
          <option value="location">Location</option>
          <option value="price">Price</option>
          <option value="spaces">Spaces</option>
        </select>

        <select v-model="sortOrder">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>

        <button
          :disabled="cart.length === 0"
          @click="currentView = 'cart'"
        >
          View Cart ({{ totalItems }})
        </button>
      </div>

      <div class="lessons">
        <div class="lesson" v-for="lesson in sortedLessons" :key="lesson._id">
          <h3>{{ lesson.subject }}</h3>
          <img :src="lesson.image" width="120" height="120" />

          <p>Location: {{ lesson.location }}</p>
          <p>Price: ${{ lesson.price }}</p>
          <p>Spaces: {{ lesson.spaces }}</p>

          <button @click="addToCart(lesson)" :disabled="lesson.spaces === 0">
            Add to Cart
          </button>
        </div>
      </div>
    </div>

    <!-- Cart Page -->
    <div v-if="currentView === 'cart'" class="cart-page">
      <h2>Your Cart</h2>

      <ul v-if="cart.length > 0">
        <li v-for="item in cart" :key="item.lessonId">
          {{ item.subject }} — ${{ item.price }} × {{ item.quantity }}
          <button class="minus-btn" @click="removeOne(item)">−</button>
        </li>
      </ul>

      <p v-else>Your cart is empty.</p>

      <div class="main-buttons">
        <button @click="currentView = 'lessons'">Back to Lessons</button>
        <button v-if="cart.length > 0" @click="currentView = 'checkout'">Checkout</button>
      </div>
    </div>

    <!-- Checkout Page -->
    <div v-if="currentView === 'checkout'" class="checkout-page">
      <h2>Checkout</h2>

      <form @submit.prevent="submitOrder">
        <label>
          Name:
          <input type="text" v-model="name" required>
        </label>

        <label>
          Phone:
          <input type="text" v-model="phone" required>
        </label>

        <label>
          Email:
          <input type="email" v-model="email" required>
        </label>

        <label>
          ZIP (optional):
          <input type="text" v-model="zip">
        </label>

        <p v-if="name && !isValidName">Name can only contain letters.</p>
        <p v-if="phone && !isValidPhone">Phone must contain digits only.</p>

        <div class="main-buttons">
          <button type="button" @click="currentView = 'cart'">Back to Cart</button>
          <button type="submit" :disabled="!formValid">Submit Order</button>
        </div>
      </form>
    </div>

    <!-- Receipt Page -->
    <div v-if="currentView === 'receipt'" class="receipt-page">
      <h2>Order Receipt</h2>

      <div class="receipt-details">
        <p><strong>Name:</strong> {{ lastOrder.name }}</p>
        <p><strong>Phone:</strong> {{ lastOrder.phone }}</p>
        <p><strong>Email:</strong> {{ lastOrder.email }}</p>
        <p v-if="lastOrder.zip"><strong>ZIP:</strong> {{ lastOrder.zip }}</p>
      </div>

      <h3>Items</h3>
      <ul>
        <li v-for="item in lastOrder.items" :key="item.lessonId">
          {{ item.subject }} × {{ item.quantity }} — 
          ${{ item.quantity * item.price }}
        </li>
      </ul>

      <p><strong>Total:</strong> ${{ lastOrder.total }}</p>

      <button @click="restart">Back to Activities</button>
    </div>

  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        currentView: 'lessons',
        lessons: [],
        cart: [],
        sortKey: 'subject',
        sortOrder: 'asc',
        searchQuery: '',
        name: '',
        phone: '',
        email: '',
        zip: '',
        lastOrder: null
      },

      computed: {

        filteredLessons() {
          if (!this.searchQuery) return this.lessons;
          let q = this.searchQuery.toLowerCase();

          return this.lessons.filter(lesson =>
            lesson.subject.toLowerCase().includes(q) ||
            lesson.location.toLowerCase().includes(q) ||
            lesson.price.toString().includes(q) ||
            lesson.spaces.toString().includes(q)
          );
        },

        sortedLessons() {
          let sorted = [...this.filteredLessons];
          sorted.sort((a, b) => {
            let mod = this.sortOrder === 'asc' ? 1 : -1;
            if (a[this.sortKey] < b[this.sortKey]) return -1 * mod;
            if (a[this.sortKey] > b[this.sortKey]) return 1 * mod;
            return 0;
          });
          return sorted;
        },

        totalItems() {
          return this.cart.reduce((sum, item) => sum + item.quantity, 0);
        },

        isValidName() {
          return /^[A-Za-z\s]+$/.test(this.name);
        },

        isValidPhone() {
          return /^[0-9]+$/.test(this.phone);
        },

        formValid() {
          return this.isValidName && this.isValidPhone && this.email && this.cart.length > 0;
        }
      },

      methods: {
        applySearch() {},

        loadLessons() {
          fetch('https://cst3144-backend-wyke.onrender.com/collection/lessons')
            .then(res => res.json())
            .then(data => {
              this.lessons = data;
            });
        },

        addToCart(lesson) {
          if (lesson.spaces === 0) return;

          let existing = this.cart.find(i => i.lessonId === lesson._id);

          if (existing) {
            existing.quantity++;
          } else {
            this.cart.push({
              lessonId: lesson._id,
              subject: lesson.subject,
              price: lesson.price,
              quantity: 1
            });
          }

          lesson.spaces--;
        },

        removeOne(item) {
          let lesson = this.lessons.find(l => l._id === item.lessonId);
          if (lesson) lesson.spaces++;

          item.quantity--;
          if (item.quantity === 0) {
            this.cart = this.cart.filter(i => i.lessonId !== item.lessonId);
          }
        },

        submitOrder() {
          const order = {
            name: this.name,
            phone: this.phone,
            email: this.email,
            zip: this.zip,
            items: JSON.parse(JSON.stringify(this.cart)),
            total: this.cart.reduce((sum, i) => sum + i.price * i.quantity, 0)
          };

          fetch('https://cst3144-backend-wyke.onrender.com/collection/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(order)
          });

          this.cart.forEach(item => {
            const updatedSpaces = this.lessons.find(l => l._id === item.lessonId).spaces;

            fetch(`https://cst3144-backend-wyke.onrender.com/collection/lessons/${item.lessonId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ spaces: updatedSpaces })
            });
          });

          this.lastOrder = order;
          this.cart = [];
          this.currentView = 'receipt';
        },

        restart() {
          this.lastOrder = null;
          this.name = "";
          this.phone = "";
          this.email = "";
          this.zip = "";
          this.currentView = 'lessons';
          this.loadLessons();
        }
      },

      mounted() {
        this.loadLessons();
      }
    });
  </script>
</body>
</html>
